# Setting Up GitLab CI Runners for Killerbeez

We use GitLab to develop Killerbeez internally; these are the instructions for
creating CI runners that test the build on a number of platforms.

## Prerequisites

* A GitLab server hosting Killerbeez
* A CI server with the following installed:
    * Vagrant
    * VirtualBox

## Instructions

* Clone this repo onto your server
* `cd vagrant/ci_runner`
* `cp runner_vars.example runner_vars`
* Edit `runner_vars` with the parameters of your Gitlab server:
    * `CI_SERVER_URL` - HTTPS URL to the GitLab server
    * `REGISTRATION TOKEN` - CI token generated by GitLab (get it from the
      Settings > CI/CD > Runners page for the Killerbeez project)
    * `CI_SERVER_TLS_CA_FILE` - If your GitLab server's certificate is signed
      by a private CA, place the CA certificate in the `vagrant/ci_runner`
      directory and set this variable. The certificate will be copied to
      `/killerbeez` in the VM, so if your certificate is named
      `ca.crt`, set `CI_SERVER_TLS_CA_FILE=/killerbeez/ca.crt`.
    * Any other settings that gitlab-runner accepts as environment variables.
      See `gitlab-runner register -h` for more options.
* `vagrant up`

This will bring up the runners for a bunch of platforms. If you would like to
bring up the runners one at a time, first run
```
vagrant status
```
to see the list of runners available, then run
```
vagrant up <vm_name>
```
to bring up the specified VM.

## Technical Details

There are three kinds of runners created by the Vagrantfile:

1. For OSes that are listed as supported by the [official Linux package
   repositories](https://docs.gitlab.com/runner/install/linux-repository.html)
   we start up a VM from a Vagrant Box of that OS and install the gitlab-runner
   package. The runner uses the `shell` executor to run builds.
2. For all other linux platforms, we prebuild a Docker image of the OS with
   dependency packages installed. We run gitlab-runner in a docker container
   and use the `docker` executor to run builds using the prebuilt OS image.
3. Windows. For these we download the gitlab-runner binary directly and install
   it as a service.

In all cases, the `.gitlab-ci.yml` specifies the OSes to build on using tags.
The Docker runners are configured with the prebuilt docker image as the default
so that it does not have to be specified in the job configuration.
